<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Experiencia Laboral</title>

    <link rel="stylesheet" th:href="@{/css/aspirante-menu.css}">
    <link rel="stylesheet" th:href="@{/css/experiencia-laboral.css}">
</head>

<body>

<div class="layout">

    <!-- TOPBAR -->
    <header class="topbar">
        <div class="topbar-left">
            <span class="brand">EMPLEO</span>

            <button id="toggleSidebar" class="menu-toggle">
                <span></span><span></span><span></span>
            </button>
        </div>

        <div class="topbar-right">
            <img class="avatar" th:src="@{${fotoAspirante}}">
            <span class="user-name" th:text="${nombreAspirante}">Aspirante</span>
        </div>
    </header>

    <div class="body">

        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar">
            <ul>
                <li><a th:href="@{/aspirante/datos-personales}">
                    <img src="/img/icon-datos.png">
                    <span>Datos Personales</span>
                </a></li>

                <li><a th:href="@{/aspirante/escolaridad}">
                    <img src="/img/icon-escolaridad.png">
                    <span>Escolaridad</span>
                </a></li>

                <li class="active"><a th:href="@{/aspirante/experiencia-laboral}">
                    <img src="/img/icon-experiencia.png">
                    <span>Experiencia Laboral</span>
                </a></li>

                <li><a th:href="@{/aspirante/capacitacion}">
                    <img src="/img/icon-capacitacion1.png">
                    <span>Capacitación</span>
                </a></li>

                <li><a th:href="@{/aspirante/conocimientos}">
                    <img src="/img/icon-conocimiento.png">
                    <span>Conocimientos Específicos</span>
                </a></li>

                <li><a th:href="@{/aspirante/competencias}">
                    <img src="/img/icon-competencias.png">
                    <span>Competencias y Habilidades</span>
                </a></li>

                <li><a th:href="@{/aspirante/cargardocumentos}">
                    <img src="/img/icon-competencias.png">
                    <span>Cargar Documentos</span>
                </a></li>

                <li><a th:href="@{/aspirante/cambiar-contrasena}">
                    <img src="/img/icon-password.png">
                    <span>Cambiar Contraseña</span>
                </a></li>

                <li><a th:href="@{/aspirante/eliminar-cuenta}">
                    <img src="/img/icon-eliminar.png">
                    <span>Eliminar Usuario</span>
                </a></li>
            </ul>

            <div class="logout-section">
                <a th:href="@{/logout}" class="logout-btn">CERRAR SESIÓN</a>
            </div>
        </aside>

        <!-- CONTENIDO -->
        <main id="content" class="content">

            <h2 class="titulo-seccion">EXPERIENCIA LABORAL</h2>
            <p class="sub-text">Gestiona tu información de experiencias laborales realizadas.</p>

            <button class="btn-add" onclick="mostrarFormulario()">+ Agregar nuevo</button>

            <!-- LISTA DE EXPERIENCIA -->
            <table class="tabla-registros">
                <thead>
                <tr>
                    <th>Empleo</th>
                    <th>Sector general</th>
                    <th>Sector público</th>
                    <th>Área laboral</th>
                    <th>Empresa / Dependencia</th>
                    <th>Año inicio</th>
                    <th>Año fin</th>
                    <th>Años</th>
                    <th>Meses</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="x : ${listaExperiencia}">
                    <td th:text="${x.tipoEmpleoNombre}">ACTUAL</td>
                    <td th:text="${x.sectorGeneralNombre}">PRIVADO</td>
                    <td th:text="${x.sectorNombre}">ESTATAL</td>
                    <td th:text="${x.laboralNombre}">TI</td>
                    <td th:text="${x.empresa}">Empresa</td>
                    <td th:text="${x.fechaInicio != null ? x.fechaInicio.year : ''}"></td>
                    <td th:text="${x.fechaFin != null ? x.fechaFin.year : ''}"></td>
                    <td th:text="${x.anios}"></td>
                    <td th:text="${x.meses}"></td>
                    <td>
                        <a th:href="@{'/aspirante/experiencia-laboral/editar/' + ${x.idExperienciaLaboral}}"
                           class="btn-edit">Editar</a>
                        <a th:href="@{'/aspirante/experiencia-laboral/eliminar/' + ${x.idExperienciaLaboral}}"
                           onclick="return confirm('¿Eliminar registro?')"
                           class="btn-delete">Eliminar</a>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- FORMULARIO -->

                <div id="form-experiencia"
                     th:class="'form-box ' + (${mostrarForm} ? '' : 'hidden')">


                <h2 class="titulo-seccion">DATOS LABORALES</h2>

                <form th:action="@{/aspirante/experiencia-laboral/guardar}"
                      th:object="${experienciaForm}"
                      method="post">

                    <!-- OCULTOS -->
                    <input type="hidden" th:field="*{idExperienciaLaboral}">
                    <input type="hidden" th:field="*{idPersona}">

                    <!-- ====== BLOQUE 1: DATOS LABORALES ====== -->
                    <div class="row">
                        <div class="col">
                            <label>Empleo a describir como:</label>
                            <select th:field="*{idTipoEmpleo}">
                                <option value="">-- SELECCIONAR --</option>
                                <option th:each="e : ${empleos}"
                                        th:value="${e.idTipoEmpleo}"
                                        th:text="${e.desTipoEmpleo}">
                                </option>
                            </select>
                        </div>

                        <div class="col">
                            <label>Sector general:</label>
                            <select th:field="*{idSectorGeneral}">
                                <option value="">-- SELECCIONAR --</option>
                                <option th:each="s : ${sectoresGenerales}"
                                        th:value="${s.idSectorGeneral}"
                                        th:text="${s.desSectorGeneral}">
                                </option>
                            </select>
                        </div>

                        <div class="col">
                            <label>Sector público:</label>
                            <select th:field="*{idSector}">
                                <option value="">-- SELECCIONAR --</option>
                                <option th:each="sp : ${sectoresPublicos}"
                                        th:value="${sp.idSector}"
                                        th:text="${sp.nomSector}">
                                </option>
                            </select>
                        </div>

                        <div class="col">
                            <label>Área laboral:</label>
                            <select th:field="*{idLaboral}">
                                <option value="">-- SELECCIONAR --</option>
                                <option th:each="al : ${areasLaborales}"
                                        th:value="${al.idLaboral}"
                                        th:text="${al.desLaboral}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Área laboral específica:</label>
                            <input type="text" th:field="*{areaLaboralEspecifica}">
                        </div>

                        <div class="col">
                            <label>Nombre de la empresa o dependencia:</label>
                            <input type="text" th:field="*{empresa}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Fecha de inicio:</label>
                            <input type="date" th:field="*{fechaInicio}" id="fechaInicio">
                        </div>

                        <div class="col">
                            <label>Fecha de término:</label>
                            <input type="date" th:field="*{fechaFin}" id="fechaFin">
                        </div>

                        <div class="col">
                            <label>Años de experiencia:</label>
                            <input type="number" th:field="*{anios}" id="aniosExp" readonly>
                        </div>

                        <div class="col">
                            <label>Meses de experiencia:</label>
                            <input type="number" th:field="*{meses}" id="mesesExp" readonly>
                        </div>
                    </div>

                    <hr class="divider">

                    <!-- ====== BLOQUE 2: DESCRIPCIÓN DEL EMPLEO ====== -->
                    <h2 class="titulo-seccion">DESCRIPCIÓN DEL EMPLEO</h2>

                    <div class="row">
                        <div class="col">
                            <label>Nivel:</label>
                            <input type="number" th:field="*{nivelPuesto}">
                        </div>

                        <div class="col">
                            <label>Sueldo mensual recibido:</label>
                            <select th:field="*{idSueldo}">
                                <option value="">-- SELECCIONAR --</option>
                                <option th:each="s : ${sueldos}"
                                        th:value="${s.idSueldo}"
                                        th:text="${s.rango}">
                                </option>
                            </select>
                        </div>

                        <div class="col">
                            <label>Tipo de contratación:</label>
                            <select th:field="*{idTipoContratacion}">
                                <option value="">-- SELECCIONAR --</option>
                                <option th:each="t : ${tiposContratacion}"
                                        th:value="${t.idTipoContratacion}"
                                        th:text="${t.desTipo}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Funciones desempeñadas:</label>
                            <textarea th:field="*{funciones}" rows="3"></textarea>
                        </div>

                        <div class="col">
                            <label>Otra función desempeñada:</label>
                            <textarea th:field="*{otraFuncion}" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Motivo de separación (catálogo):</label>
                            <select th:field="*{idMotivoSeparacion}">
                                <option value="">-- SELECCIONAR --</option>
                                <option th:each="m : ${motivosSeparacion}"
                                        th:value="${m.idMotivo}"
                                        th:text="${m.desMotivo}">
                                </option>
                            </select>
                        </div>

                        <div class="col">
                            <label>Motivo de separación (descripción):</label>
                            <input type="text" th:field="*{motivoSeparacion}">
                        </div>
                    </div>

                    <div class="acciones">
                        <button type="button" class="btn-cancelar" onclick="cancelar()">CANCELAR</button>
                        <button type="submit" class="btn-guardar">GUARDAR</button>
                    </div>

                </form>

            </div>

        </main>
    </div>
</div>

<script th:src="@{/js/aspirante-menu.js}"></script>

<script>
    function mostrarFormulario() {
        document.getElementById("form-experiencia").classList.remove("hidden");
    }

    function cancelar() {
        document.getElementById("form-experiencia").classList.add("hidden");
    }

    // ======= CÁLCULO AUTOMÁTICO AÑOS / MESES =======
    const fechaInicioInput = document.getElementById("fechaInicio");
    const fechaFinInput = document.getElementById("fechaFin");
    const aniosExpInput = document.getElementById("aniosExp");
    const mesesExpInput = document.getElementById("mesesExp");

    function calcularExperiencia() {
        const fi = fechaInicioInput.value ? new Date(fechaInicioInput.value) : null;
        const ff = fechaFinInput.value ? new Date(fechaFinInput.value) : null;

        if (!fi || !ff) {
            aniosExpInput.value = "";
            mesesExpInput.value = "";
            return;
        }

        if (ff < fi) {
            alert("⚠ La fecha de término no puede ser menor a la fecha de inicio.");
            aniosExpInput.value = "";
            mesesExpInput.value = "";
            return;
        }

        let years = ff.getFullYear() - fi.getFullYear();
        let months = ff.getMonth() - fi.getMonth();

        if (months < 0) {
            years--;
            months += 12;
        }

        aniosExpInput.value = years;
        mesesExpInput.value = months;
    }

    fechaInicioInput.addEventListener("change", calcularExperiencia);
    fechaFinInput.addEventListener("change", calcularExperiencia);
</script>

</body>
</html>
