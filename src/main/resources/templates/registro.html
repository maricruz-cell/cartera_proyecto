<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Registro - Datos Personales</title>
    <link rel="stylesheet" th:href="@{/css/registro-datos.css}">
</head>

<body>

<div class="wrapper">

    <h1 class="titulo">¡¡DATOS PERSONALES!!</h1>

    <p class="subtexto">
        Por favor, ingresa la información correctamente.<br>
        Todos los campos son obligatorios para crear tu cuenta.
    </p>

    <form class="formulario" th:action="@{/registro}" method="post" th:object="${registroDto}">

        <!-- Fila 1 -->
        <div class="fila">
            <div class="campo">
                <label>Nombre(s):</label>
                <input type="text" id="nombre" th:field="*{nombre}" placeholder="Tu nombre" required>
            </div>

            <div class="campo">
                <label>Apellido Paterno:</label>
                <input type="text" id="apellidoPaterno" th:field="*{apellidoPaterno}" placeholder="Apellido" required>
            </div>

            <div class="campo">
                <label>Apellido Materno:</label>
                <input type="text" id="apellidoMaterno" th:field="*{apellidoMaterno}" placeholder="Apellido">
            </div>
        </div>

        <!-- Fila 2 -->
        <div class="fila">
            <div class="campo">
                <label>Género:</label>
                <select id="sexo" name="sexo" th:field="*{sexo}">
                    <option value="">Seleccionar</option>
                    <option th:each="s : ${sexos}"
                            th:value="${s.id_sexo}"
                            th:text="${s.des_sexo}">
                    </option>
                </select>
            </div>

            <div class="campo">
                <label>Fecha de Nacimiento:</label>
                <input type="date" id="fechaNacimiento" th:field="*{fechaNacimiento}" required>
            </div>

            <div class="campo">
                <label>Edad:</label>
                <input type="number" th:field="*{edad}" id="edad" placeholder="Edad" readonly>
            </div>

            <div class="campo">
                <label>Estado de Nacimiento:</label>
                <select id="estadoNacimiento" th:field="*{idEstado}">
                    <option value="">Seleccionar</option>
                    <option th:each="e : ${estados}"
                            th:value="${e.idEstado}"
                            th:text="${e.nomEstado}">
                    </option>
                </select>

            </div>
        </div>

        <!-- Fila 3 -->
        <div class="fila">
            <div class="campo">
                <label>CURP:</label>
                <input type="text" id="curp" th:field="*{curp}" placeholder="CURP Generada">
            </div>

            <div class="campo">
                <label>RFC:</label>
                <input type="text" id="rfc" th:field="*{rfc}" placeholder="RFC Generado">
            </div>

            <div class="campo">
                <label>Estado Civil:</label>
                <select name="estadoCivil" th:field="*{estadoCivil}">
                    <option value="">Seleccionar</option>
                    <option th:each="ec : ${estadosCiviles}"
                            th:value="${ec.id_estado_civil}"
                            th:text="${ec.descripcion}">
                    </option>
                </select>
            </div>
        </div>

        <!-- Fila 4 -->
        <div class="fila">
            <div class="campo">
                <label>Nacionalidad:</label>
                <select name="nacionalidad" th:field="*{nacionalidad}">
                    <option value="">Seleccionar</option>
                    <option th:each="n : ${nacionalidades}"
                            th:value="${n.id_nacionalidad}"
                            th:text="${n.descripcion}">
                    </option>
                </select>
            </div>

            <div class="campo">
                <label>Correo Electrónico:</label>
                <input type="email" th:field="*{correo}" placeholder="Escribe tu correo electrónico" required>
            </div>

            <div class="campo">
                <label>Confirmar Correo:</label>
                <input type="email" th:field="*{correoConfirmacion}" placeholder="Escribe tu correo electrónico" required>
            </div>
        </div>

        <!-- Fila 5 -->
        <div class="fila">
            <div class="campo">
                <label>Genera tu contraseña:</label>
                <input type="password" th:field="*{contrasena}" placeholder="Escribe su contraseña" required>
            </div>

            <div class="campo">
                <label>Confirmar contraseña:</label>
                <input type="password" th:field="*{contrasenaConfirmacion}" placeholder="Escribe nuevamente tu contraseña" required>
            </div>
        </div>

        <!-- Botón -->
        <div class="contenedor-boton">
            <button type="submit" class="btn-continuar">Continuar →</button>
        </div>

        <!-- Franja -->
        <img src="/img/franja-dorada.png" class="franja">

        <div th:if="${error}" class="error-msg" th:text="${error}"></div>

    </form>
</div>

<script>

    function limpiarNombre(nombreOriginal) {
        if (!nombreOriginal) return "";
        let n = nombreOriginal.trim().toUpperCase();
        let partes = n.split(/\s+/);

        const prohibidos = ["JOSE", "J", "J.", "MARIA", "MA", "MA."];
        if (partes.length > 1 && prohibidos.includes(partes[0])) {
            partes.shift();
        }
        return partes.join(" ");
    }

    function normalizar(s) {
        if (!s) return "";
        let up = s.toUpperCase();
        up = up.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        up = up.replace(/Ñ/g, "X");
        return up;
    }

    function primeraVocalInterna(txt) {
        for (let i = 1; i < txt.length; i++) {
            if ("AEIOU".includes(txt[i])) return txt[i];
        }
        return "X";
    }

    function primeraConsonanteInterna(txt) {
        for (let i = 1; i < txt.length; i++) {
            const c = txt[i];
            if (/[A-Z]/.test(c) && !"AEIOU".includes(c)) return c;
        }
        return "X";
    }

    function obtenerClaveEstadoJs(idEstadoStr) {
        const id = parseInt(idEstadoStr, 10);
        return ({
            1:"AS",2:"BC",3:"BS",4:"CC",5:"CL",6:"CM",7:"CS",8:"CH",
            9:"DF",10:"DG",11:"GT",12:"GR",13:"HG",14:"JC",15:"MC",16:"MN",
            17:"MS",18:"NT",19:"NL",20:"OC",21:"PL",22:"QT",23:"QR",24:"SP",
            25:"SL",26:"SR",27:"TC",28:"TS",29:"TL",30:"VZ",31:"YN",32:"ZS"
        }[id] || "NE");
    }

    function generarCurpJs() {
        const nombre = normalizar(limpiarNombre(document.getElementById("nombre").value));
        const ap = normalizar(document.getElementById("apellidoPaterno").value);
        const am = normalizar(document.getElementById("apellidoMaterno").value);
        const fecha = document.getElementById("fechaNacimiento").value;
        const sexo = document.getElementById("sexo").value.toUpperCase();
        const estado = obtenerClaveEstadoJs(document.getElementById("estadoNacimiento").value);

        if (!nombre || !ap || !fecha || !sexo || estado === "NE") return;

        const fn = new Date(fecha);
        const year = String(fn.getFullYear()).slice(-2);
        const month = ("0" + (fn.getMonth() + 1)).slice(-2);
        const day = ("0" + fn.getDate()).slice(-2);

        let curp = "";
        curp += ap[0];
        curp += primeraVocalInterna(ap);
        curp += (am[0] || "X");
        curp += nombre[0];
        curp += year + month + day;
        curp += sexo[0];
        curp += estado;
        curp += primeraConsonanteInterna(ap);
        curp += primeraConsonanteInterna(am);
        curp += primeraConsonanteInterna(nombre);
        curp += "01";

        document.getElementById("curp").value = curp;
    }

    ["nombre","apellidoPaterno","apellidoMaterno","fechaNacimiento","sexo","estadoNacimiento"]
        .forEach(id => {
            document.getElementById(id).addEventListener("change", generarCurpJs);
            document.getElementById(id).addEventListener("keyup", generarCurpJs);
        });



function calcularEdadJs() {
    const fecha = document.getElementById("fechaNacimiento").value;
    const edadInput = document.getElementById("edad");

    if (!fecha) {
        edadInput.value = "";
        return;
    }

    const hoy = new Date();
    const nacimiento = new Date(fecha);

    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mes = hoy.getMonth() - nacimiento.getMonth();

    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }

    edadInput.value = edad;
}

document.getElementById("fechaNacimiento")
        .addEventListener("change", function () {
            calcularEdadJs();
            generarCurpJs(); // recalcula curp
        });

</script>


</body>
</html>
